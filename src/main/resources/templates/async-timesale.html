<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Async Time Sale Service (v3)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f6f9f8;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            color: #333;
        }

        h2, h3 {
            font-weight: bold;
            color: #3c988f;
        }

        .nav-tabs .nav-link {
            font-weight: 600;
            color: #3c988f;
            border-radius: 10px 10px 0 0;
        }

        .nav-tabs .nav-link.active {
            background-color: #d4f1ed;
            border-color: #d4f1ed #d4f1ed transparent;
        }

        .section-card {
            background-color: #ffffff;
            border: none;
            border-radius: 1rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.04);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-control {
            border-radius: 0.7rem;
        }

        .btn-mint {
            background-color: #3c988f;
            border: none;
            color: white;
            font-weight: bold;
            padding: 0.6rem 2rem;
            border-radius: 999px;
        }

        .btn-mint:hover {
            background-color: #33877f;
        }

        .card-time-sale {
            border-radius: 1rem;
            border: none;
            background-color: #ffffff;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
        }

        .muted {
            color: #aaa;
        }
    </style>
</head>
<body>
<div class="container my-5">
    <h2 class="mb-4">âš¡ Async Time Sale Service (v3)</h2>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <ul class="nav nav-tabs mb-5">
        <li class="nav-item">
            <a class="nav-link" href="/ui/product">ìƒí’ˆ</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/ui/time-sale">íƒ€ì„ì„¸ì¼ (V1/V2)</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="/ui/async-time-sale">íƒ€ì„ì„¸ì¼ (ë¹„ë™ê¸°)</a>
        </li>
    </ul>

    <!-- íƒ€ì„ì„¸ì¼ ìƒì„± -->
    <div class="section-card">
        <h3>ğŸ“ íƒ€ì„ì„¸ì¼ ìƒì„±</h3>
        <form id="createForm" class="mt-4">
            <div class="mb-3">
                <label for="productId" class="form-label">ìƒí’ˆ ID</label>
                <input type="number" class="form-control" id="productId" required>
            </div>
            <div class="mb-3">
                <label for="quantity" class="form-label">ìˆ˜ëŸ‰</label>
                <input type="number" class="form-control" id="quantity" required>
            </div>
            <div class="mb-3">
                <label for="discountPrice" class="form-label">í• ì¸ ê°€ê²©</label>
                <input type="number" class="form-control" id="discountPrice" required>
            </div>
            <div class="mb-3">
                <label for="startAt" class="form-label">ì‹œì‘ ì‹œê°„</label>
                <input type="datetime-local" class="form-control" id="startAt" required>
            </div>
            <div class="mb-3">
                <label for="endAt" class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                <input type="datetime-local" class="form-control" id="endAt" required>
            </div>
            <div class="text-end">
                <button type="submit" class="btn-mint">ìƒì„±í•˜ê¸°</button>
            </div>
        </form>
    </div>

    <!-- íƒ€ì„ì„¸ì¼ êµ¬ë§¤ -->
    <div class="section-card">
        <h3>ğŸ›ï¸ íƒ€ì„ì„¸ì¼ êµ¬ë§¤</h3>
        <form id="purchaseForm" class="mt-4">
            <div class="mb-3">
                <label for="timeSaleId" class="form-label">íƒ€ì„ì„¸ì¼ ID</label>
                <input type="number" class="form-control" id="timeSaleId" required>
            </div>
            <div class="mb-3">
                <label for="userId" class="form-label">ì‚¬ìš©ì ID</label>
                <input type="number" class="form-control" id="userId" required>
            </div>
            <div class="mb-3">
                <label for="purchaseQuantity" class="form-label">ìˆ˜ëŸ‰</label>
                <input type="number" class="form-control" id="purchaseQuantity" required>
            </div>
            <div class="text-end">
                <button type="submit" class="btn-mint">êµ¬ë§¤ ìš”ì²­</button>
            </div>
        </form>
    </div>

    <!-- ìƒíƒœ í™•ì¸ -->
    <div class="section-card">
        <h3>ğŸ“¦ êµ¬ë§¤ ìƒíƒœ ì¡°íšŒ</h3>
        <form id="statusForm" class="mt-4">
            <div class="mb-3">
                <label for="checkTimeSaleId" class="form-label">íƒ€ì„ì„¸ì¼ ID</label>
                <input type="number" class="form-control" id="checkTimeSaleId" required>
            </div>
            <div class="mb-3">
                <label for="requestId" class="form-label">ìš”ì²­ ID</label>
                <input type="text" class="form-control" id="requestId" required>
            </div>
            <div class="text-end">
                <button type="submit" class="btn-mint">ì¡°íšŒí•˜ê¸°</button>
            </div>
        </form>
        <div id="statusResult" class="mt-3"></div>
    </div>

    <!-- íƒ€ì„ì„¸ì¼ ëª©ë¡ -->
    <div class="section-card">
        <h3>ğŸ“‹ íƒ€ì„ì„¸ì¼ ëª©ë¡</h3>
        <div class="text-end mb-3">
            <button id="refreshList" class="btn btn-outline-secondary">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="timeSalesList"></div>
    </div>
</div>

<script>
    const BASE_URL = '/api/v3';

    const createForm = document.getElementById('createForm');
    const purchaseForm = document.getElementById('purchaseForm');
    const statusForm = document.getElementById('statusForm');
    const refreshButton = document.getElementById('refreshList');
    const timeSalesList = document.getElementById('timeSalesList');
    const statusResult = document.getElementById('statusResult');

    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const response = await fetch(BASE_URL + '/time-sales', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    productId: parseInt(document.getElementById('productId').value),
                    quantity: parseInt(document.getElementById('quantity').value),
                    discountPrice: parseInt(document.getElementById('discountPrice').value),
                    startAt: document.getElementById('startAt').value,
                    endAt: document.getElementById('endAt').value
                })
            });
            const result = await response.json();
            alert('âœ… íƒ€ì„ì„¸ì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ID: ' + result.id);
            loadTimeSales();
        } catch (error) {
            alert('ì˜¤ë¥˜: ' + error);
        }
    });

    purchaseForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const response = await fetch(BASE_URL + '/time-sales/' + document.getElementById('timeSaleId').value + '/purchase', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: parseInt(document.getElementById('userId').value),
                    quantity: parseInt(document.getElementById('purchaseQuantity').value)
                })
            });
            const result = await response.json();
            alert('ğŸ‰ êµ¬ë§¤ ìš”ì²­ ì™„ë£Œ! ìš”ì²­ ID: ' + result.requestId);
            document.getElementById('checkTimeSaleId').value = document.getElementById('timeSaleId').value;
            document.getElementById('requestId').value = result.requestId;
        } catch (error) {
            alert('êµ¬ë§¤ ì‹¤íŒ¨: ' + error);
        }
    });

    statusForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const timeSaleId = document.getElementById('checkTimeSaleId').value;
        const requestId = document.getElementById('requestId').value;

        try {
            const response = await fetch(BASE_URL + '/time-sales/purchase/result/' + timeSaleId + '/' + requestId);
            const result = await response.json();

            statusResult.innerHTML = `
        <div class="card card-time-sale">
          <div class="card-body">
            <h5 class="card-title">ğŸ•µï¸ ìƒíƒœ: ${result.status}</h5>
            <p class="card-text">
              ${result.queuePosition ? `ëŒ€ê¸° ìˆœë²ˆ: ${result.queuePosition}<br>` : ''}
              ${result.totalWaiting ? `ì „ì²´ ëŒ€ê¸° ìˆ˜: ${result.totalWaiting}` : ''}
            </p>
          </div>
        </div>
      `;

            if (result.status === 'PENDING') {
                setTimeout(() => statusForm.dispatchEvent(new Event('submit')), 1000);
            }
        } catch (error) {
            console.error('ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', error);
        }
    });

    async function loadTimeSales() {
        try {
            const response = await fetch(BASE_URL + '/time-sales');
            const data = await response.json();
            const timeSales = data.content;
            timeSalesList.innerHTML = timeSales.map(ts => `
        <div class="card card-time-sale mb-3">
          <div class="card-body">
            <h5 class="card-title">ğŸ§¾ íƒ€ì„ì„¸ì¼ ID: ${ts.id}</h5>
            <p class="card-text">
              ìƒí’ˆ: ${ts.productName}<br>
              ê°€ê²©: â‚©${ts.price.toLocaleString()}<br>
              í• ì¸ ê°€ê²©: â‚©${ts.discountPrice.toLocaleString()}<br>
              ì¬ê³ : ${ts.remainingQuantity}/${ts.quantity}<br>
              ìƒíƒœ: ${ts.status}<br>
              ì‹œì‘: ${ts.startAt}<br>
              ì¢…ë£Œ: ${ts.endAt}
            </p>
          </div>
        </div>
      `).join('');
        } catch (error) {
            console.error('íƒ€ì„ì„¸ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        }
    }

    refreshButton.addEventListener('click', loadTimeSales);
    loadTimeSales();
</script>
</body>
</html>