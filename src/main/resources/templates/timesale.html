<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Time Sale Management</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f6f9f8;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            color: #333;
        }

        h2 {
            font-weight: bold;
            color: #3c988f;
        }

        .nav-tabs .nav-link {
            font-weight: 600;
            color: #3c988f;
            border-radius: 10px 10px 0 0;
        }

        .nav-tabs .nav-link.active {
            background-color: #d4f1ed;
            border-color: #d4f1ed #d4f1ed transparent;
        }

        .section-card {
            background-color: #ffffff;
            border: none;
            border-radius: 1rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.04);
            padding: 2rem;
        }

        .section-card .card-header {
            background-color: transparent;
            border-bottom: none;
            font-size: 1.25rem;
            color: #3c988f;
            font-weight: bold;
        }

        .form-control {
            border-radius: 0.7rem;
        }

        .btn-mint {
            background-color: #3c988f;
            border: none;
            color: white;
            font-weight: bold;
            padding: 0.6rem 2rem;
            border-radius: 999px;
        }

        .btn-mint:hover {
            background-color: #33877f;
        }

        .card-time-sale {
            border-radius: 1rem;
            border: none;
            background-color: #ffffff;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
        }

        .muted {
            color: #aaa;
        }
    </style>
</head>
<body>
<div class="container my-5">
    <h2 class="mb-4">â° íƒ€ì„ì„¸ì¼ ê´€ë¦¬</h2>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <ul class="nav nav-tabs mb-5">
        <li class="nav-item">
            <a class="nav-link" href="/ui/product">ìƒí’ˆ</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="/ui/time-sale">íƒ€ì„ì„¸ì¼ (V1/V2)</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/ui/async-time-sale">íƒ€ì„ì„¸ì¼ (ë¹„ë™ê¸°)</a>
        </li>
    </ul>

    <!-- íƒ€ì„ì„¸ì¼ ë“±ë¡ -->
    <div class="section-card mb-5">
        <div class="card-header">ğŸ“ ìƒˆ íƒ€ì„ì„¸ì¼ ìƒì„±</div>
        <form id="createTimeSaleForm" class="mt-4">
            <div class="mb-3">
                <label for="version" class="form-label">ë²„ì „</label>
                <select class="form-select" id="version" required>
                    <option value="v1">Version 1</option>
                    <option value="v2">Version 2</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="productId" class="form-label">ìƒí’ˆ ID</label>
                <input type="number" class="form-control" id="productId" required>
            </div>
            <div class="mb-3">
                <label for="quantity" class="form-label">ìˆ˜ëŸ‰</label>
                <input type="number" class="form-control" id="quantity" required>
            </div>
            <div class="mb-3">
                <label for="discountPrice" class="form-label">í• ì¸ ê°€ê²©</label>
                <input type="number" class="form-control" id="discountPrice" required>
            </div>
            <div class="mb-3">
                <label for="startAt" class="form-label">ì‹œì‘ ì‹œê°„</label>
                <input type="datetime-local" class="form-control" id="startAt" required>
            </div>
            <div class="mb-3">
                <label for="endAt" class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                <input type="datetime-local" class="form-control" id="endAt" required>
            </div>
            <div class="text-end">
                <button type="submit" class="btn-mint">ìƒì„±í•˜ê¸°</button>
            </div>
        </form>
    </div>

    <!-- íƒ€ì„ì„¸ì¼ ëª©ë¡ -->
    <div id="timeSaleList" class="mt-4"></div>

    <!-- êµ¬ë§¤ ëª¨ë‹¬ -->
    <div class="modal fade" id="purchaseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content rounded-3">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ›ï¸ íƒ€ì„ì„¸ì¼ êµ¬ë§¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseForm">
                        <input type="hidden" id="timeSaleId">
                        <div class="mb-3">
                            <label for="userId" class="form-label">ì‚¬ìš©ì ID</label>
                            <input type="number" class="form-control" id="userId" required>
                        </div>
                        <div class="mb-3">
                            <label for="purchaseQuantity" class="form-label">êµ¬ë§¤ ìˆ˜ëŸ‰</label>
                            <input type="number" class="form-control" id="purchaseQuantity" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn-mint" id="confirmPurchase">êµ¬ë§¤í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            $('#createTimeSaleForm').submit(function (e) {
                e.preventDefault();
                const version = $('#version').val();
                const data = {
                    productId: parseInt($('#productId').val()),
                    quantity: parseInt($('#quantity').val()),
                    discountPrice: parseInt($('#discountPrice').val()),
                    startAt: $('#startAt').val(),
                    endAt: $('#endAt').val()
                };

                $.ajax({
                    url: `/api/${version}/time-sales`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function () {
                        alert('âœ… íƒ€ì„ì„¸ì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        loadTimeSales();
                        $('#createTimeSaleForm')[0].reset();
                        $('#version').val('v1');
                    },
                    error: function (xhr) {
                        alert('âš ï¸ ì˜¤ë¥˜: ' + xhr.responseText);
                    }
                });
            });

            function loadTimeSales() {
                const version = $('#version').val() || 'v1';
                $.ajax({
                    url: `/api/${version}/time-sales`,
                    method: 'GET',
                    success: function (response) {
                        const timeSales = response.content;
                        const timeSaleList = $('#timeSaleList');
                        timeSaleList.empty();

                        if (!timeSales.length) {
                            timeSaleList.append('<div class="text-center text-muted py-4">íƒ€ì„ì„¸ì¼ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>');
                            return;
                        }

                        timeSales.forEach(function (ts) {
                            const card = $(`
                <div class="card card-time-sale mb-3">
                  <div class="card-body">
                    <h5 class="card-title">ğŸ§¾ ìƒí’ˆ ID: ${ts.productId}</h5>
                    <p class="card-text">
                      ìˆ˜ëŸ‰: ${ts.quantity}<br>
                      ì”ì—¬: ${ts.remainingQuantity}<br>
                      í• ì¸ ê°€ê²©: â‚©${ts.discountPrice.toLocaleString()}<br>
                      ì‹œì‘: ${ts.startAt}<br>
                      ì¢…ë£Œ: ${ts.endAt}<br>
                      ìƒíƒœ: ${ts.status}
                    </p>
                    <button class="btn-mint purchase-btn"
                            data-time-sale-id="${ts.id}"
                            ${ts.status === 'ACTIVE' ? '' : 'disabled'}>
                      êµ¬ë§¤í•˜ê¸°
                    </button>
                  </div>
                </div>
              `);
                            timeSaleList.append(card);
                        });
                    },
                    error: function (xhr) {
                        alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + xhr.responseText);
                    }
                });
            }

            $(document).on('click', '.purchase-btn', function () {
                $('#timeSaleId').val($(this).data('time-sale-id'));
                $('#purchaseModal').modal('show');
            });

            $('#confirmPurchase').click(function () {
                const version = $('#version').val() || 'v1';
                const timeSaleId = $('#timeSaleId').val();
                const userId = $('#userId').val();
                const quantity = $('#purchaseQuantity').val();

                if (!userId || !quantity) {
                    alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                $.ajax({
                    url: `/api/${version}/time-sales/${timeSaleId}/purchase`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ userId: parseInt(userId), quantity: parseInt(quantity) }),
                    success: function () {
                        alert('ğŸ‰ êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        $('#purchaseModal').modal('hide');
                        loadTimeSales();
                    },
                    error: function (xhr) {
                        alert('êµ¬ë§¤ ì‹¤íŒ¨: ' + xhr.responseText);
                    }
                });
            });

            $('#version').change(loadTimeSales);
            loadTimeSales();
        });
    </script>
</div>
</body>
</html>